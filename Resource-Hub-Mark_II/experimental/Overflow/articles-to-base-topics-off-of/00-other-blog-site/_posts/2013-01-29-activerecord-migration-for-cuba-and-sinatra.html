<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>2013-01-29-activerecord-migration-for-cuba-and-sinatra</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
</head>
<body>
<p><a href="http://2.bp.blogspot.com/-FNAYC_NgaDc/UQeOcMTMbrI/AAAAAAAALOQ/bKCITp9Ye0E/s1600/sinatra.png"><img src="http://2.bp.blogspot.com/-FNAYC_NgaDc/UQeOcMTMbrI/AAAAAAAALOQ/bKCITp9Ye0E/s1600/sinatra.png" /></a></p>
<p>Rails like highly featured frameworks are already packed with the rake tasks for database migrations. But recently when I was playing with <a href="http://cuba.is/">cuba</a>, a micro <a href="https://github.com/soveran/cuba">framework</a> for ruby, I really wanted to setup migrations so that I can handle database changes in production without hassle. The migration tasks are not bundle with cuba, so I wrote two tasks to handle database creation and database migration. Here is my Rakefile looks like</p>
<pre><code>require &#39;active_record&#39;
 
task(:environment) do
  env = ENV[&quot;RACK_ENV&quot;] ? ENV[&quot;RACK_ENV&quot;] : &quot;development&quot;
  ActiveRecord::Base.establish_connection(YAML::load_file(&#39;config.yml&#39;)[&#39;database&#39;][env])
end
 
namespace :db do
  task(:create =&gt; :environment) do
    env = ENV[&quot;RACK_ENV&quot;] ? ENV[&quot;RACK_ENV&quot;] : &quot;development&quot;
    config = YAML::load_file(&#39;config.yml&#39;)[&#39;database&#39;][env]
    ActiveRecord::Base.establish_connection(config.merge(&#39;database&#39; =&gt; nil))
    ActiveRecord::Base.connection.create_database config[&#39;database&#39;]
  end
 
  task(:migrate =&gt; :environment) do
    ActiveRecord::Migrator.migrate(&#39;db/migrate&#39;, ENV[&#39;VERSION&#39;] ? ENV[&#39;VERSION&#39;].to_i : nil)
  end
end</code></pre>
<p>So now I can keep my ActiveRecord migration in the folder db/migrate and use the rake commands to execute it. I can create the db using the command</p>
<pre><code>rake db:create</code></pre>
<p>Then migrate using the command</p>
<pre><code>rake db:migrate</code></pre>
<p>You can use <strong><span style="background-color: white; color: #dd1144; font-family: Consolas; font-size: 15px; font-weight: bold; vertical-align: baseline; white-space: pre-wrap;">RACK_ENV</span></strong><span style="font-family: Arial;"><span style="font-size: 15px; white-space: pre-wrap;"> to specify the environment and </span></span><strong><span style="background-color: white; color: #dd1144; font-family: Consolas; font-size: 15px; font-weight: bold; vertical-align: baseline; white-space: pre-wrap;">VERSION</span></strong> to specify version to which you want to migrate Eg :</p>
<pre><code>rake db:create RACK_ENV=production
        rake db:migrate VERSION=10</code></pre>
<p>This can be used in both cuba and <a href="http://www.sinatrarb.com/">sinatra</a>.</p>
<p>$</p>
</body>
</html>
